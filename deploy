# /bin/bash

## Determine to which network to attach
X="$(ifconfig)"
if echo $X | grep -q "192.168.86"
then
   echo "Cantopilot is on home network"
   ADDR="192.168.86.31" # 31 FOR 3.1[41592] (PI)
elif echo $X | grep -q "192.160.10"
then
   echo "Cantopilot is its own access point"
   ADDR="192.160.10.1" 
else
   echo "Can't find cantopilot"
   exit 1
fi

echo "Deploying to address $ADDR"
cd /Users/avrouwenve/Private/adrianAutoPilot
if [ "$1" == "" ]
then
   export timestamp=$(date +%Y%m%d%H%M%S)
   echo "Using timestamp $timestamp"
   target=deployment_$timestamp.tar
   tar --exclude "__pycache__" --exclude logs --exclude archive --exclude test_config* --exclude *_overrides.yaml --exclude logging.conf -cf $target configuration modules run_*.sh web
   # tar --exclude "__pycache__" --exclude logs --exclude archive --exclude test_config* -cf $target configuration modules run_*.sh web
   scp $target tc@$ADDR:/mnt/mmcblk0p2/apps/adrianAutoPilot/$target
else
   target=$1
   echo "Will try to deploy existing remote $target"
fi
ssh tc@$ADDR "(cd /mnt/mmcblk0p2/apps/adrianAutoPilot \
  && touch configuration modules testing web \
  && sudo chmod -R ugo+w modules testing web \
  && rm -fr modules testing web Documents *.sh \
  && tar -xf $target \
  && rm -f $target \
  && echo "Deployment of $target to tc@$ADDR complete." \
  && echo "NOTE To persist deployment, run filetool.sh -b" )|| echo Deployment of $target to tc@$ADDR FAILED!"

